<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>숏츠 자동화 프로그램 - UI</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #d3d9e2 0%, #a8b4c2 100%);
            --panel-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --accent-color: #667eea;
            --accent-hover: #5a67d8;
            --card-bg: rgb(225, 231, 235);
            --card-border: #e2e8f0;
            --download-bg: #28a745;
            --download-hover-bg: #218838;
            --upload-bg: #f8f9ff;
            --upload-border: #667eea;
            --upload-hover-bg: #f0f2ff;
            --upload-hover-border: #764ba2;
            --btn-disabled-bg: #ccc;
            --success-bg: #d4edda;
            --success-text: #155724;
            --success-border: #2f4434;
            --error-bg: #bfc9c7;
            --error-text: #721c24;
            --error-border: #cfe3e3;
            --input-bg: rgb(209, 225, 224);
            --input-border: #ddd;
        }

        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #08282f 0%, #1a2a2f 100%);
            --panel-bg: rgba(30, 45, 50, 0.95);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #405560;
            --accent-color: #00897b;
            --accent-hover: #00695c;
            --card-bg: #2c3e50;
            --card-border: #405560;
            --download-bg: #388e3c;
            --download-hover-bg: #2e7d32;
            --upload-bg: #2a3f34;
            --upload-border: #26a69a;
            --upload-hover-bg: #37454f;
            --btn-disabled-bg: #555;
            --success-bg: #2e7d32;
            --success-text: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 1rem;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 7fr 3fr; /* 7:3 비율로 조정 */
            gap: 2rem;
        }

        .left-panel, .right-panel {
            background: var(--panel-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .resizer {
            background-color: rgba(0,0,0,0.1);
            cursor: col-resize;
            width: 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .resizer:hover, .resizer.active {
            background-color: #667eea;
        }

        .header {
            text-align: center;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .title-box {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 0.8rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        body.dark-mode .title-box {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .header .title-box {
            display: inline-block;
            text-align: center;
            padding: 0.8rem 1.5rem;
        }
        
        .left-panel .title-box,
        .right-panel .title-box {
            margin-bottom: 1.5rem;
        }

        .right-panel .title-box {
            align-self: center;
            text-align: center;
        }

        .title-box > * {
            margin: 0;
            padding: 0;
        }

        .title-box h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .title-box p {
            color: var(--text-secondary);
        }

        .header-actions {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-logo {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-60%); /* Adjusted from -50% to move it up */
            height: 77px; /* Reduced from 96px (approx 20% reduction) */
            width: auto;
        }

        #theme-toggle {
            position: static;
            flex-shrink: 0;
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #theme-toggle:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: rotate(15deg);
        }

        .upload-section {
            background: #000;
            border: none;
            aspect-ratio: 16 / 9;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            transform: scale(1.01);
            background: #111;
        }

        .upload-section.dragover {
            background: #222;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: white;
            margin-bottom: 1rem;
        }

        .upload-section h3 {
            color: white;
        }
        
        .upload-section p {
            color: #ccc;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: var(--success-bg);
            color: var(--success-text);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .options-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .option-group {
            background: var(--upload-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .option-group:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }

        .option-group h3 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .platform-selection {
            /* Override theme variables for this section to mimic dark mode */
            --card-bg: #2c3e50;
            --card-border: #405560;
            --text-primary: #e0e0e0;
            --accent-color: #00897b;

            background: #2a3f34;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .platform-selection h3 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .platform-grid {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            flex-wrap: nowrap;
            gap: 1.5rem;
            width: 100%;
        }

        .platform-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap; /* 창 크기가 줄어들면 줄바꿈 되도록 */
            align-items: center;
        }

        .llm-group {
            padding-left: 1.5rem;
            border-left: 1px solid var(--card-border);
        }

        .llm-card {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .llm-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .llm-card.selected {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .platform-empty-space {
            display: none; /* 이제 사용하지 않음 */
        }

        .platform-card {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 10px;
            padding: 0.75rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 120px;
            font-size: 0.8rem;
            color: var(--text-primary); /* Use variable for text color */
        }

        .platform-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .platform-card.selected {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .platform-icon {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
        }

        .process-section {
            text-align: center;
        }

        .process-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 1rem 3rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .process-btn:hover {
            transform: translateY(-3px);
            background: var(--accent-hover);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .process-btn:disabled {
            background: var(--btn-disabled-bg);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            margin-top: 2rem;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-text {
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* 오른쪽 패널 스타일 */
        .video-preview-section {
            margin-bottom: 2rem;
            display: none; /* Hidden by default */
        }

        .video-preview-section h3 {
            color: var(--text-primary);
            margin-bottom: 1.5rem; /* More space */
            text-align: center;
        }

        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
            width: 100%;
            height: 400px; /* Set a fixed height for the container */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Show the entire video without cropping */
        }

        .video-placeholder {
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            font-size: 1.2rem;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
            aspect-ratio: 9 / 16;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .control-btn:hover {
            background: var(--accent-hover);
        }

        .control-btn:disabled {
            background: var(--btn-disabled-bg);
            cursor: not-allowed;
        }

        .results-section {
            display: block;
        }

        .results-section h3 {
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .result-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 9 / 16;
            max-width: 240px;
            width: 100%;
            background: var(--upload-bg);
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            color: var(--text-secondary);
            text-align: center;
            padding: 1rem;
            margin: 0 auto;
        }

        .result-video-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-video-item {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .result-video-item h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .result-video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
            aspect-ratio: 9 / 16;
            max-width: 240px; /* Set max-width as requested */
            margin-left: auto;
            margin-right: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Fill the container for 9:16 shorts */
        }

        .result-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .download-btn {
            background: var(--download-bg);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .download-btn:hover {
            background: var(--download-hover-bg);
        }

        .upload-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: var(--accent-hover);
        }

        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .upload-modal.active {
            display: flex;
        }

        .upload-modal-content {
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            padding: 0.5rem;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .modal-btn.upload {
            background: var(--accent-color);
            color: white;
        }

        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
        }

        .status-message.success {
            background: var(--success-bg);
            color: var(--success-text);
            border: 1px solid var(--success-border);
        }

        .status-message.error {
            background: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-border);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
            
            .right-panel {
                order: -1;
            }
        }

        main {
            display: flex;
            flex: 1;
            min-height: 0;
            margin-top: 10px;
        }

        #video-display-section {
            width: 50%; /* 초기 너비 */
            min-width: 300px;
            display: flex;
            flex-direction: column;
            padding-right: 5px;
            /* border-right 속성 제거 */
        }

        #resizer {
            width: 5px;
            cursor: col-resize;
            background-color: var(--border-color);
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        #resizer:hover {
            background-color: var(--accent-color);
        }

        #video-work-section {
            flex-grow: 1; /* 남은 공간을 모두 차지 */
            min-width: 300px;
            display: flex;
            flex-direction: column;
            padding-left: 5px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .setting-item:first-of-type {
            margin-top: 0.5rem;
        }

        .setting-item label {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .setting-input {
            width: 80px;
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--input-border);
            text-align: center;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }

        body.dark-mode .setting-input {
            color: #1a202c; /* Dark text for light inputs in dark mode */
        }

        #videoEditorContainer {
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 2rem;
            /* aspect-ratio 제거 */
        }

        #videoPreview {
            width: 100%;
            height: auto;
            max-height: 500px; /* 비디오 최대 높이 제한 추가 */
            display: block; /* 수직 정렬 문제 방지 */
        }

        .short-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }

        .short-item .video-container {
            position: relative;
            cursor: pointer;
            aspect-ratio: 9 / 16;
            background-color: #000;
            margin: 0 auto;
            height: auto;
        }

        .short-item video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .short-item .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.7);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .short-item .video-container:hover .video-overlay {
            opacity: 1;
        }

        .short-info {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--upload-bg);
            gap: 0.5rem;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        #completedShortsGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(292px, 1fr));
            gap: 1.5rem;
            align-items: start;
            justify-items: center;
        }

        .selection-container {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            align-items: stretch;
        }

        .dark-selection-box {
            --card-bg: #2c3e50;
            --card-border: #405560;
            --text-primary: #e0e0e0;
            --accent-color: #00897b;
            background: #2a3f34;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }

        .selection-container .dark-selection-box:first-child {
            flex: 6;
        }
        
        .selection-container .dark-selection-box:last-child {
            flex: 4;
        }

        .dark-selection-box h3 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .short-item {
            border: 1px solid var(--card-border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .short-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }

        .short-item .video-container {
            position: relative;
            cursor: pointer;
            aspect-ratio: 9 / 16;
            background-color: #000;
            margin: 0 auto;
            height: auto;
        }

        .short-item video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }
        
        .short-item .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.7);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .short-item .video-container:hover .video-overlay {
            opacity: 1;
        }

        .short-info {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--upload-bg);
            gap: 0.5rem;
        }

        /* --- Right Panel Chat Styles --- */
        .chat-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            overflow: hidden; /* 자식 요소가 부모를 넘지 않도록 */
            min-height: 0; /* flex-grow가 제대로 작동하기 위해 필요 */
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        #newChatBtn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #newChatBtn:hover {
            background-color: var(--accent-hover);
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
            max-width: 85%;
        }

        .chat-message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .chat-message .message-content {
            background-color: var(--upload-bg);
            padding: 0.75rem 1rem;
            border-radius: 15px;
            color: var(--text-secondary);
        }
        
        .chat-message .message-content p {
            margin: 0;
            line-height: 1.5;
            white-space: pre-line; /* 줄바꿈 지원 */
        }

        .user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .user-message .message-content {
            background-color: var(--accent-color);
            color: white;
        }

        .ai-message {
            align-self: flex-start;
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
        }

        #chatInput {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-primary);
            resize: none;
            font-family: inherit;
            font-size: 1rem;
        }

        #chatInput:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #sendChatBtn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }
        
        #sendChatBtn:disabled {
             background: var(--btn-disabled-bg);
             cursor: not-allowed;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 2rem; /* 섹션 사이 간격 */
        }

        #resultsContainer {
            flex-shrink: 0;
        }

        .selection-container {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            align-items: stretch;
        }

        .dark-selection-box {
            --card-bg: #2c3e50;
            --card-border: #405560;
            --text-primary: #e0e0e0;
            --accent-color: #00897b;
            background: #2a3f34;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }

        .dark-selection-box h3 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        #completedShortsGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(292px, 1fr));
            gap: 1.5rem;
            align-items: start;
            justify-items: center;
        }

        .ai-model-box {
            justify-content: space-between;
        }
        .ai-model-box .chat-input-area {
            padding: 0;
            border-top: none;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
        }
        .ai-model-box #chatInput {
            background-color: #ffffff; /* 흰색 배경 */
            color: #000000; /* 검은색 폰트 */
            border: 1px solid #d1d5db; /* 밝은 회색 테두리 */
        }
        .ai-model-box #chatInput::placeholder {
            color: #6b7280; /* 어두운 회색 placeholder */
        }
        .ai-model-box #chatInput:focus {
            border-color: var(--accent-color);
        }
        .ai-model-box #sendChatBtn {
            background-color: var(--accent-color);
            color: white;
            font-weight: normal;
        }

        .ai-model-box .ai-model-container {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            width: 90%;
            margin: 0 auto;
        }
        
        .ai-model-container .setting-input {
            color: #1a202c; /* 검은색 텍스트 */
            background-color: #ffffff; /* 흰색 배경 */
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            padding: 0.65rem;
            font-size: 0.9rem;
            flex-grow: 1;
        }

        .ai-model-container .setting-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 137, 123, 0.2);
        }

        .ai-model-container .settings-btn {
            background: none;
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            transition: all 0.2s;
        }

        .ai-model-container .settings-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
        }

        /* --- API Key Modal Styles --- */
        .api-key-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }

        .api-key-modal .modal-content {
            background-color: #fefefe;
            color: #1a202c;
            margin: 15% auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        .api-key-modal .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .api-key-modal .close-button:hover,
        .api-key-modal .close-button:focus {
            color: black;
            text-decoration: none;
        }

        .api-key-modal h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .api-key-modal .form-group {
            margin-bottom: 1.5rem;
        }
        
        .api-key-modal .form-label-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .api-key-modal .form-label-group label {
            font-size: 1rem;
            font-weight: 600;
        }

        .api-key-modal #apiKeyLink {
            font-size: 0.85rem;
            color: #007bff;
            text-decoration: none;
        }

        .api-key-modal #apiKeyLink:hover {
            text-decoration: underline;
        }

        .api-key-modal .form-group-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            color: #000000;
        }

        .api-key-modal .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .api-key-modal .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .api-key-modal .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .api-key-modal .btn-secondary:hover {
            background-color: #5a6268;
        }

        .api-key-modal .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .api-key-modal .btn-primary:hover {
            background-color: #0056b3;
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        @keyframes slideIn {
            from {transform: translateY(-50px);}
            to {transform: translateY(0);}
        }

        .left-panel .chat-panel {
            flex: 7;
            margin-bottom: 0;
            max-height: none;
        }

        .chat-area {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            height: 450px;
        }

        .chat-list-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-list-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-list-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text-primary);
        }
        
        #selectAllChats {
             width: 16px;
             height: 16px;
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        
        .chat-list-item:hover {
            background-color: var(--upload-bg);
        }

        .chat-list-item.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-hover);
        }

        .chat-list-item input[type="checkbox"] {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }

        .chat-list-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            padding-left: 0.5rem; /* Add some space between checkbox and text */
        }
        
        .chat-list-item-title:hover {
            text-decoration: underline;
        }


        .chat-list-actions {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .chat-list-actions button {
            padding: 0.6rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--upload-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1rem;
        }

        .chat-list-actions button:hover {
            background-color: var(--border-color);
        }

        .shorts-carousel {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            max-width: 360px; /* Set to desired width */
        }

        .shorts-viewport {
            width: 100%;
            overflow: hidden;
        }

        #shortsTrack {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            display: none; /* Initially hidden */
        }

        .carousel-btn.prev {
            left: -50px;
        }

        .carousel-btn.next {
            right: -50px;
        }

        .volume-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .volume-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .progress-bar-container {
            width: 90%;
            height: 4px;
            background-color: #ccc;
            cursor: pointer;
            border-radius: 2px;
            margin: 8px auto 4px auto;
        }
        body.dark-mode .progress-bar-container {
             background-color: rgba(255, 255, 255, 0.3);
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            border-radius: 2px;
        }

        #shorts-counter {
            text-align: center;
            margin-top: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .short-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 8px 0;
            background: var(--upload-bg);
        }

        .short-controls button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            padding: 0;
            line-height: 1;
        }

        .short-controls button:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .short-controls button.active {
            color: var(--accent-color);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- 왼쪽 패널: 설정 및 컨트롤 -->
        <div class="left-panel">
            <div class="header">
                <img src="image/TwinverseLogo.png" alt="Twinverse Logo" class="header-logo">
                <div class="title-box">
                    <h1>🎬 숏츠 자동화 프로그램</h1>
                </div>
                <div class="header-actions">
                    <button id="loadNewVideoButton" class="upload-btn">새 영상 불러오기 📂</button>
                    <button id="theme-toggle">🌙</button>
                </div>
            </div>

            <!-- 파일 업로드 섹션 -->
            <div class="upload-section" id="uploadContainer">
                <div class="upload-icon">📁</div>
                <h3>영상 파일을 드래그하거나 클릭하여 업로드</h3>
                <p>MP4, AVI, MOV 파일 지원</p>
                <input type="file" id="file-input" class="file-input" accept="video/*">
                <div class="file-info" id="fileInfo">
                    <p id="fileName"></p>
                    <p id="fileSize"></p>
                </div>
            </div>

            <!-- 원본 영상 미리보기 (업로드 후 표시) -->
            <div class="video-preview-section" id="videoPreviewSection">
                <h3>📹&nbsp;원본 영상 미리보기</h3>
                <div class="video-container" id="originalVideoContainer">
                    <div class="video-placeholder">
                        영상을 업로드하면 여기에서 미리볼 수 있습니다
                    </div>
                </div>
                <div class="video-controls">
                    <button class="control-btn" id="playBtn" disabled>▶️ 재생</button>
                    <button class="control-btn" id="pauseBtn" disabled>⏸️ 일시정지</button>
                    <button class="control-btn" id="rewindBtn" disabled>⏪ 되감기</button>
                </div>
            </div>
            
            <!-- 처리 옵션 섹션 -->
            <div id="videoEditorContainer" style="display: none;">
                <video id="videoPreview" controls></video>
            </div>

            <div class="options-section">
                <div class="option-group">
                    <h3>📼 영상 처리</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="autoHighlight" name="video_processing" value="highlight" checked>
                            <label for="autoHighlight">자동 하이라이트 추출</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="autoCrop" name="video_processing" value="crop" checked>
                            <label for="autoCrop">자동 크롭</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="colorCorrection" name="video_processing" value="color" checked>
                            <label for="colorCorrection">색상 보정</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="videoStabilization" name="video_processing" value="stabilize">
                            <label for="videoStabilization">영상 안정화</label>
                        </div>
                    </div>
                </div>

                <div class="option-group">
                    <h3>🔊 오디오 처리</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="removeSilence" name="audio_processing" value="silence" checked>
                            <label for="removeSilence">무음 구간 제거</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="enhanceAudio" name="audio_processing" value="enhance" checked>
                            <label for="enhanceAudio">오디오 향상</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="noiseReduction" name="audio_processing" value="noise" checked>
                            <label for="noiseReduction">노이즈 감소</label>
                        </div>
                    </div>
                </div>

                <div class="option-group">
                    <h3>📝&nbsp;추가 기능</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="addTitle" name="features" value="title">
                            <label for="addTitle">타이틀 추가</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="addSubtitles" name="features" value="subtitles">
                            <label for="addSubtitles">자막 추가</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="addEffects" name="features" value="effects">
                            <label for="addEffects">영상효과 추가</label>
                        </div>
                    </div>
                </div>

                <div class="option-group">
                    <h3>⚙️&nbsp;숏츠 생성 설정</h3>
                    <div class="setting-item">
                        <label for="shortsLength">영상 길이</label>
                        <select id="shortsLength" class="setting-input">
                            <option value="15">15초</option>
                            <option value="30">30초</option>
                            <option value="45">45초</option>
                            <option value="60" selected>60초</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="shortsCount">생성 개수</label>
                        <input type="number" id="shortsCount" class="setting-input" value="1" min="1" max="10">
                    </div>
                </div>

                <div class="option-group">
                    <h3>📁&nbsp;저장 관리</h3>
                    <div class="setting-item">
                        <label for="outputFolder">저장 폴더</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" id="outputFolder" class="setting-input" placeholder="폴더를 선택하세요" readonly style="flex: 1;">
                            <button id="selectFolderBtn" class="control-btn" style="padding: 0.5rem;">📁</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="autoSave">자동 저장</label>
                        <input type="checkbox" id="autoSave" checked>
                    </div>
                    <div class="setting-item">
                        <label for="fileNaming">파일명 형식</label>
                        <select id="fileNaming" class="setting-input">
                            <option value="timestamp">타임스탬프 (20241220_143022)</option>
                            <option value="sequential">순차번호 (shorts_001, shorts_002)</option>
                            <option value="custom">사용자 정의</option>
                        </select>
                    </div>
                    <div class="setting-item" id="customNameContainer" style="display: none;">
                        <label for="customName">사용자 정의명</label>
                        <input type="text" id="customName" class="setting-input" placeholder="예: MyShorts">
                    </div>
                </div>
            </div>

            <div class="chat-area">
                <div class="chat-list-panel">
                    <div class="chat-list-header">
                        <h3>대화 목록</h3>
                        <input type="checkbox" id="selectAllChats" title="전체 선택">
                    </div>
                    <div class="chat-list" id="chatList">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="chat-list-actions">
                        <button id="saveChatsBtn" title="모든 대화 저장">💾 저장</button>
                        <button id="loadChatsBtn" title="파일에서 불러오기">📂 불러오기</button>
                        <input type="file" id="loadChatsInput" style="display: none;" accept=".json">
                        <button id="deleteChatsBtn" title="선택 대화 삭제">🗑️ 삭제</button>
                    </div>
                </div>

                <div class="chat-panel">
                    <div class="chat-header">
                        <h3>AI 어시스턴트</h3>
                        <button id="newChatBtn">새 대화</button>
                    </div>
                    <div class="chat-history" id="chatHistory">
                        <!-- Chat messages will be appended here -->
                    </div>
                </div>
            </div>

            <div class="selection-container">
                <div class="dark-selection-box">
                    <h3>🌐&nbsp;플랫폼 선택</h3>
                    <div class="platform-group">
                        <div class="platform-card" data-platform="youtube_shorts">
                            <div class="platform-icon">📺</div>
                            YouTube Shorts
                        </div>
                        <div class="platform-card" data-platform="instagram_reels">
                            <div class="platform-icon">📸</div>
                            Instagram Reels
                        </div>
                        <div class="platform-card" data-platform="tiktok">
                            <div class="platform-icon">🎵</div>
                            TikTok
                        </div>
                        <div class="platform-card" data-platform="naver">
                            <div class="platform-icon">KR</div>
                            네이버
                        </div>
                        <div class="platform-card" data-platform="facebook_reels">
                            <div class="platform-icon">👥</div>
                            Facebook Reels
                        </div>
                    </div>
                </div>
    
                <div class="dark-selection-box ai-model-box">
                    <div class="chat-input-area">
                        <textarea id="chatInput" placeholder="AI에게 영상 처리를 요청하세요..." rows="1"></textarea>
                        <button id="sendChatBtn" disabled>전송</button>
                    </div>
                    <div class="ai-model-container">
                        <select id="mainModelSelect" class="setting-input"></select>
                        <select id="subModelSelect" class="setting-input"></select>
                        <button class="settings-btn" id="apiSettingsBtn" title="API 키 설정">⚙️</button>
                    </div>
                </div>
            </div>

            <div class="process-section">
                <button id="processBtn" class="process-btn" disabled>🚀&nbsp;영상 처리 시작</button>
            </div>

            <!-- 진행률 표시 -->
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-text" id="statusText">처리 중...</div>
            </div>
        </div>

        <!-- 오른쪽 패널: 결과 -->
        <div class="right-panel">
            <div id="resultsContainer">
                <div class="title-box">
                    <h3>✅ 완성된 숏츠 영상</h3>
                </div>
                <div class="shorts-carousel">
                    <button class="carousel-btn prev" id="prevShortBtn">‹</button>
                    <div class="shorts-viewport">
                        <div id="shortsTrack">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                    <button class="carousel-btn next" id="nextShortBtn">›</button>
                </div>
                <div id="shorts-counter"></div>
                <div id="completedShortsGrid" style="display: none;">
                    <!-- This is now unused, but kept for safety, will be controlled by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- 업로드 모달 -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-modal-content">
            <h3 id="modalTitle">플랫폼 업로드</h3>
            <form class="upload-form" id="uploadForm">
                <div class="form-group">
                    <label for="videoTitle">제목</label>
                    <input type="text" id="videoTitle" required>
                </div>
                <div class="form-group">
                    <label for="videoDescription">설명</label>
                    <textarea id="videoDescription" placeholder="영상에 대한 설명을 입력하세요..."></textarea>
                </div>
                <div class="form-group">
                    <label for="videoTags">태그 (쉼표로 구분)</label>
                    <input type="text" id="videoTags" placeholder="예: 숏츠, 유튜브, 재미있는">
                </div>
            </form>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelUpload">취소</button>
                <button class="modal-btn upload" id="confirmUpload">업로드</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="api-key-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="apiKeyModalTitle">API 키 설정</h3>
            <div class="form-group">
                <div class="form-label-group">
                    <label for="apiKeyInput">API 키</label>
                    <a href="#" id="apiKeyLink" target="_blank" rel="noopener noreferrer">API 키 발급받기 &nearr;</a>
                </div>
                <input type="password" id="apiKeyInput" class="form-group-input">
            </div>
            <div class="modal-actions">
                <button id="cancelApiKey" class="btn btn-secondary">취소</button>
                <button id="saveApiKey" class="btn btn-primary">저장</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const themeToggle = document.getElementById('theme-toggle');
            
            // Upload related
            const uploadContainer = document.getElementById('uploadContainer');
            const fileInput = document.getElementById('file-input');

            // Video Preview related
            const videoEditorContainer = document.getElementById('videoEditorContainer');
            const videoPreview = document.getElementById('videoPreview');
            
            // Controls and buttons
            const processBtn = document.getElementById('processBtn');
            const platformCards = document.querySelectorAll('.platform-card');
            const loadNewVideoButton = document.getElementById('loadNewVideoButton');
            
            // Storage management elements
            const selectFolderBtn = document.getElementById('selectFolderBtn');
            const outputFolder = document.getElementById('outputFolder');
            const autoSave = document.getElementById('autoSave');
            const fileNaming = document.getElementById('fileNaming');
            const customName = document.getElementById('customName');
            const customNameContainer = document.getElementById('customNameContainer');
            
            // Results related
            const resultsContainer = document.getElementById('resultsContainer');
            const completedShortsGrid = document.getElementById('completedShortsGrid');
            const shortsTrack = document.getElementById('shortsTrack');
            const prevShortBtn = document.getElementById('prevShortBtn');
            const nextShortBtn = document.getElementById('nextShortBtn');
            const shortsCounter = document.getElementById('shorts-counter');

            // Chat panel elements
            const chatHistory = document.getElementById('chatHistory');
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const newChatBtn = document.getElementById('newChatBtn');

            // Chat List elements
            const chatList = document.getElementById('chatList');
            const selectAllChats = document.getElementById('selectAllChats');
            const saveChatsBtn = document.getElementById('saveChatsBtn');
            const loadChatsBtn = document.getElementById('loadChatsBtn');
            const loadChatsInput = document.getElementById('loadChatsInput');
            const deleteChatsBtn = document.getElementById('deleteChatsBtn');

            let uploadedFile = null;
            let chats = [];
            let currentChatId = null;
            let allGeneratedShorts = [];
            let currentShortIndex = 0;
            let outputFolderHandle = null;
            let savedShortsCount = 0;

            // --- AI Model Data & Logic ---
            const aiModels = {
                claude: { 
                    name: "Claude", 
                    subModels: [
                        "Claude 3.5 Sonnet", 
                        "Claude 3.5 Haiku", 
                        "Claude 3 Opus", 
                        "Claude 3 Sonnet", 
                        "Claude 3 Haiku"
                    ], 
                    apiKey: "", 
                    apiKeyUrl: "https://console.anthropic.com/settings/keys",
                    endpoint: "https://api.anthropic.com/v1/messages"
                },
                gpt: { 
                    name: "OpenAI GPT", 
                    subModels: [
                        "GPT-4o", 
                        "GPT-4o mini", 
                        "GPT-4 Turbo", 
                        "GPT-4", 
                        "GPT-3.5 Turbo", 
                        "GPT-3.5 Turbo 16k"
                    ], 
                    apiKey: "", 
                    apiKeyUrl: "https://platform.openai.com/api-keys",
                    endpoint: "https://api.openai.com/v1/chat/completions"
                },
                gemini: { 
                    name: "Google Gemini", 
                    subModels: [
                        "Gemini 2.0 Flash", 
                        "Gemini 1.5 Pro", 
                        "Gemini 1.5 Flash", 
                        "Gemini 1.5 Flash-8B", 
                        "Gemini 1.0 Pro"
                    ], 
                    apiKey: "", 
                    apiKeyUrl: "https://aistudio.google.com/app/api-keys",
                    endpoint: "https://generativelanguage.googleapis.com/v1beta/models"
                },
                groq: { 
                    name: "Groq", 
                    subModels: [
                        "Llama 3.3 70B", 
                        "Llama 3.1 405B", 
                        "Llama 3.1 70B", 
                        "Llama 3.1 8B", 
                        "Llama 3 70B", 
                        "Llama 3 8B", 
                        "Mixtral 8x7B", 
                        "Gemma 2 9B", 
                        "Gemma 7B"
                    ], 
                    apiKey: "", 
                    apiKeyUrl: "https://console.groq.com/keys",
                    endpoint: "https://api.groq.com/openai/v1/chat/completions"
                },
                perplexity: {
                    name: "Perplexity",
                    subModels: [
                        "Llama 3.1 Sonar Large",
                        "Llama 3.1 Sonar Small", 
                        "Llama 3.1 70B",
                        "Llama 3.1 8B"
                    ],
                    apiKey: "",
                    apiKeyUrl: "https://www.perplexity.ai/settings/api",
                    endpoint: "https://api.perplexity.ai/chat/completions"
                },
                cohere: {
                    name: "Cohere",
                    subModels: [
                        "Command R+",
                        "Command R",
                        "Command",
                        "Command Light"
                    ],
                    apiKey: "",
                    apiKeyUrl: "https://dashboard.cohere.com/api-keys",
                    endpoint: "https://api.cohere.ai/v1/chat"
                }
            };

            const mainModelSelect = document.getElementById('mainModelSelect');
            const subModelSelect = document.getElementById('subModelSelect');
            const apiSettingsBtn = document.getElementById('apiSettingsBtn');
            
            // API Key Modal Elements
            const apiKeyModal = document.getElementById('apiKeyModal');
            const apiKeyModalTitle = document.getElementById('apiKeyModalTitle');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKeyLink = document.getElementById('apiKeyLink');
            const saveApiKeyBtn = document.getElementById('saveApiKey');
            const cancelApiKeyBtn = document.getElementById('cancelApiKey');
            const closeBtn = apiKeyModal.querySelector('.close-button');
            let currentEditingModel = null;

            function initializeMainModels() {
                mainModelSelect.innerHTML = '';
                for (const key in aiModels) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = aiModels[key].name;
                    mainModelSelect.appendChild(option);
                }
            }

            function updateSubModels() {
                const selectedModelKey = mainModelSelect.value;
                const subModels = aiModels[selectedModelKey].subModels;
                
                subModelSelect.innerHTML = '';
                subModels.forEach(modelName => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    option.textContent = modelName;
                    subModelSelect.appendChild(option);
                });
            }
            
            mainModelSelect.addEventListener('change', updateSubModels);

            // --- API Key Modal Logic ---
            apiSettingsBtn.addEventListener('click', () => {
                const selectedModelKey = mainModelSelect.value;
                const modelData = aiModels[selectedModelKey];
                
                apiKeyModalTitle.textContent = `${modelData.name} API 키 설정`;
                apiKeyInput.value = modelData.apiKey || '';
                apiKeyLink.href = modelData.apiKeyUrl;

                apiKeyModal.style.display = 'block';
                
                currentEditingModel = selectedModelKey;
            });

            function closeApiKeyModal() {
                 apiKeyModal.style.display = 'none';
            }

            closeBtn.addEventListener('click', closeApiKeyModal);
            cancelApiKeyBtn.addEventListener('click', closeApiKeyModal);
            
            saveApiKeyBtn.addEventListener('click', () => {
                if (currentEditingModel) {
                    aiModels[currentEditingModel].apiKey = apiKeyInput.value;
                    localStorage.setItem(`apiKey_${currentEditingModel}`, apiKeyInput.value);
                    console.log(`${aiModels[currentEditingModel].name} API Key saved.`); // For debugging
                    alert(`${aiModels[currentEditingModel].name} API 키가 저장되었습니다.`);
                    closeApiKeyModal();
                }
            });

            // Load saved API keys
            function loadSavedApiKeys() {
                for (const modelKey in aiModels) {
                    const savedKey = localStorage.getItem(`apiKey_${modelKey}`);
                    if (savedKey) {
                        aiModels[modelKey].apiKey = savedKey;
                    }
                }
            }

            // --- Storage Management Functions ---
            async function selectOutputFolder() {
                try {
                    if ('showDirectoryPicker' in window) {
                        outputFolderHandle = await window.showDirectoryPicker();
                        outputFolder.value = outputFolderHandle.name;
                        localStorage.setItem('outputFolderName', outputFolderHandle.name);
                        addMessage('ai', `📁 저장 폴더가 "${outputFolderHandle.name}"로 설정되었습니다.`);
                    } else {
                        // Fallback for browsers that don't support File System Access API
                        const folderPath = prompt('저장할 폴더 경로를 입력하세요:', 'C:\\AutoShorts\\Output');
                        if (folderPath) {
                            outputFolder.value = folderPath;
                            localStorage.setItem('outputFolderPath', folderPath);
                            addMessage('ai', `📁 저장 경로가 "${folderPath}"로 설정되었습니다.`);
                        }
                    }
                } catch (error) {
                    console.error('Folder selection error:', error);
                    addMessage('ai', '❌ 폴더 선택이 취소되었거나 오류가 발생했습니다.');
                }
            }

            function generateFileName(index, originalName = 'video') {
                const namingType = fileNaming.value;
                const now = new Date();
                
                switch (namingType) {
                    case 'timestamp':
                        const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        return `shorts_${timestamp}_${index}.mp4`;
                    
                    case 'sequential':
                        const paddedIndex = String(savedShortsCount + index).padStart(3, '0');
                        return `shorts_${paddedIndex}.mp4`;
                    
                    case 'custom':
                        const customPrefix = customName.value.trim() || 'MyShorts';
                        const paddedCustomIndex = String(index).padStart(3, '0');
                        return `${customPrefix}_${paddedCustomIndex}.mp4`;
                    
                    default:
                        return `shorts_${index}.mp4`;
                }
            }

            async function saveVideoFile(videoElement, fileName) {
                try {
                    // Create download link for the video
                    const link = document.createElement('a');
                    link.href = videoElement.src;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    return true;
                } catch (error) {
                    console.error('Save error:', error);
                    return false;
                }
            }

            async function autoSaveShorts() {
                if (!autoSave.checked) return;
                
                let savedCount = 0;
                const totalShorts = allGeneratedShorts.length;
                
                addMessage('ai', `💾 ${totalShorts}개의 숏츠를 자동 저장하고 있습니다...`);
                
                for (let i = 0; i < allGeneratedShorts.length; i++) {
                    const shortElement = allGeneratedShorts[i];
                    const video = shortElement.querySelector('video');
                    const fileName = generateFileName(i + 1);
                    
                    const success = await saveVideoFile(video, fileName);
                    if (success) {
                        savedCount++;
                        // Update UI to show saved status
                        const shortInfo = shortElement.querySelector('.short-info');
                        const savedBadge = document.createElement('span');
                        savedBadge.innerHTML = '💾 저장됨';
                        savedBadge.style.cssText = 'font-size: 0.75rem; color: var(--success-text); margin-left: 0.5rem;';
                        shortInfo.appendChild(savedBadge);
                    }
                }
                
                savedShortsCount += savedCount;
                localStorage.setItem('savedShortsCount', savedShortsCount.toString());
                
                addMessage('ai', `✅ ${savedCount}/${totalShorts}개의 숏츠가 성공적으로 저장되었습니다!`);
            }

            // Individual download function
            window.downloadSingleShort = function(button, index) {
                const shortElement = button.closest('.short-item');
                const video = shortElement.querySelector('video');
                const fileName = generateFileName(index);
                
                saveVideoFile(video, fileName).then(success => {
                    if (success) {
                        addMessage('ai', `💾 숏츠 #${index}가 "${fileName}" 이름으로 저장되었습니다.`);
                        
                        // Add saved badge if not already present
                        const shortInfo = shortElement.querySelector('.short-info');
                        if (!shortInfo.querySelector('.saved-badge')) {
                            const savedBadge = document.createElement('span');
                            savedBadge.className = 'saved-badge';
                            savedBadge.innerHTML = '💾 저장됨';
                            savedBadge.style.cssText = 'font-size: 0.75rem; color: var(--success-text); margin-left: 0.5rem;';
                            shortInfo.appendChild(savedBadge);
                        }
                    } else {
                        addMessage('ai', `❌ 숏츠 #${index} 저장에 실패했습니다.`);
                    }
                });
            };

            // Event listeners for storage management
            selectFolderBtn.addEventListener('click', selectOutputFolder);
            
            fileNaming.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customNameContainer.style.display = 'flex';
                } else {
                    customNameContainer.style.display = 'none';
                }
            });

            // Load saved settings
            function loadStorageSettings() {
                const savedFolderName = localStorage.getItem('outputFolderName');
                const savedFolderPath = localStorage.getItem('outputFolderPath');
                const savedCount = localStorage.getItem('savedShortsCount');
                
                if (savedFolderName) {
                    outputFolder.value = savedFolderName;
                } else if (savedFolderPath) {
                    outputFolder.value = savedFolderPath;
                }
                
                if (savedCount) {
                    savedShortsCount = parseInt(savedCount, 10);
                }
            }

            // --- Video Analysis Functions ---
            async function extractVideoFrames(videoElement, numFrames = 5) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const frames = [];
                
                canvas.width = 640;
                canvas.height = 360;
                
                const duration = videoElement.duration;
                const interval = duration / numFrames;
                
                for (let i = 0; i < numFrames; i++) {
                    const time = i * interval;
                    await seekToTime(videoElement, time);
                    
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    const frameData = canvas.toDataURL('image/jpeg', 0.8);
                    frames.push({
                        time: time,
                        data: frameData
                    });
                }
                
                return frames;
            }
            
            function seekToTime(videoElement, time) {
                return new Promise((resolve) => {
                    const onSeeked = () => {
                        videoElement.removeEventListener('seeked', onSeeked);
                        resolve();
                    };
                    videoElement.addEventListener('seeked', onSeeked);
                    videoElement.currentTime = time;
                });
            }

            // 현재 선택된 모든 옵션을 가져오는 함수
            function getCurrentOptions() {
                const selectedPlatforms = Array.from(getSelectedPlatforms()).map(p => p.dataset.platform);
                const platformNames = {
                    'youtube_shorts': 'YouTube Shorts',
                    'instagram_reels': 'Instagram Reels',
                    'tiktok': 'TikTok',
                    'naver': '네이버',
                    'facebook_reels': 'Facebook Reels'
                };

                return {
                    // 영상 처리 옵션
                    videoProcessing: {
                        autoHighlight: document.getElementById('autoHighlight').checked,
                        autoCrop: document.getElementById('autoCrop').checked,
                        colorCorrection: document.getElementById('colorCorrection').checked,
                        videoStabilization: document.getElementById('videoStabilization').checked
                    },
                    // 오디오 처리 옵션
                    audioProcessing: {
                        removeSilence: document.getElementById('removeSilence').checked,
                        enhanceAudio: document.getElementById('enhanceAudio').checked,
                        noiseReduction: document.getElementById('noiseReduction').checked
                    },
                    // 추가 기능
                    features: {
                        addTitle: document.getElementById('addTitle').checked,
                        addSubtitles: document.getElementById('addSubtitles').checked,
                        addEffects: document.getElementById('addEffects').checked
                    },
                    // 숏츠 설정
                    settings: {
                        shortsLength: parseInt(document.getElementById('shortsLength').value),
                        shortsCount: parseInt(document.getElementById('shortsCount').value)
                    },
                    // 선택된 플랫폼
                    platforms: selectedPlatforms.map(p => platformNames[p] || p),
                    // AI 모델 정보
                    aiModel: {
                        provider: mainModelSelect.options[mainModelSelect.selectedIndex].text,
                        model: subModelSelect.options[subModelSelect.selectedIndex].text
                    },
                    // 저장 관리 설정
                    storage: {
                        autoSave: document.getElementById('autoSave').checked,
                        outputFolder: document.getElementById('outputFolder').value,
                        fileNaming: document.getElementById('fileNaming').value,
                        customName: document.getElementById('customName').value
                    }
                };
            }

            // 옵션을 텍스트로 변환하는 함수
            function formatOptionsForAI(options) {
                let optionsText = "\n📋 현재 선택된 옵션들:\n\n";
                
                // 플랫폼 정보
                if (options.platforms.length > 0) {
                    optionsText += `🌐 타겟 플랫폼: ${options.platforms.join(', ')}\n`;
                } else {
                    optionsText += `⚠️ 플랫폼이 선택되지 않았습니다.\n`;
                }
                
                // 숏츠 설정
                optionsText += `⏱️ 숏츠 길이: ${options.settings.shortsLength}초\n`;
                optionsText += `🔢 생성 개수: ${options.settings.shortsCount}개\n\n`;
                
                // 영상 처리 옵션
                const videoOptions = [];
                if (options.videoProcessing.autoHighlight) videoOptions.push("자동 하이라이트 추출");
                if (options.videoProcessing.autoCrop) videoOptions.push("자동 크롭");
                if (options.videoProcessing.colorCorrection) videoOptions.push("색상 보정");
                if (options.videoProcessing.videoStabilization) videoOptions.push("영상 안정화");
                
                if (videoOptions.length > 0) {
                    optionsText += `📼 영상 처리: ${videoOptions.join(', ')}\n`;
                }
                
                // 오디오 처리 옵션
                const audioOptions = [];
                if (options.audioProcessing.removeSilence) audioOptions.push("무음 구간 제거");
                if (options.audioProcessing.enhanceAudio) audioOptions.push("오디오 향상");
                if (options.audioProcessing.noiseReduction) audioOptions.push("노이즈 감소");
                
                if (audioOptions.length > 0) {
                    optionsText += `🔊 오디오 처리: ${audioOptions.join(', ')}\n`;
                }
                
                // 추가 기능
                const features = [];
                if (options.features.addTitle) features.push("타이틀 추가");
                if (options.features.addSubtitles) features.push("자막 추가");
                if (options.features.addEffects) features.push("영상효과 추가");
                
                if (features.length > 0) {
                    optionsText += `✨ 추가 기능: ${features.join(', ')}\n`;
                }
                
                optionsText += `\n🤖 사용 중인 AI: ${options.aiModel.provider} - ${options.aiModel.model}\n`;
                
                // 저장 관리 설정
                if (options.storage.outputFolder) {
                    optionsText += `📁 저장 폴더: ${options.storage.outputFolder}\n`;
                }
                optionsText += `💾 자동 저장: ${options.storage.autoSave ? '활성화' : '비활성화'}\n`;
                optionsText += `📝 파일명 형식: ${options.storage.fileNaming === 'timestamp' ? '타임스탬프' : options.storage.fileNaming === 'sequential' ? '순차번호' : '사용자 정의'}\n`;
                
                return optionsText;
            }

            async function analyzeVideoContent(message) {
                if (!uploadedFile || !videoPreview.src) {
                    return "영상이 업로드되지 않았습니다. 먼저 영상을 업로드해주세요.";
                }
                
                try {
                    // Extract frames from video
                    const frames = await extractVideoFrames(videoPreview, 3);
                    
                    // Get video metadata
                    const videoInfo = {
                        duration: Math.round(videoPreview.duration),
                        width: videoPreview.videoWidth,
                        height: videoPreview.videoHeight,
                        aspectRatio: (videoPreview.videoWidth / videoPreview.videoHeight).toFixed(2)
                    };
                    
                    // 현재 선택된 옵션들 가져오기
                    const currentOptions = getCurrentOptions();
                    const optionsText = formatOptionsForAI(currentOptions);
                    
                    const analysisPrompt = `
영상 분석 및 숏츠 제작 요청: ${message}

📹 영상 정보:
- 길이: ${videoInfo.duration}초
- 해상도: ${videoInfo.width}x${videoInfo.height}
- 화면비: ${videoInfo.aspectRatio}:1

${optionsText}

🎯 요청사항:
1. 현재 선택된 옵션들을 모두 고려하여 영상을 분석해주세요.
2. 선택된 플랫폼(${currentOptions.platforms.join(', ')})에 최적화된 편집 방법을 제안해주세요.
3. ${currentOptions.settings.shortsCount}개의 ${currentOptions.settings.shortsLength}초 숏츠를 만들기 위한 최적의 구간을 추천해주세요.
4. 선택된 처리 옵션들(하이라이트 추출, 크롭, 색상보정 등)의 적용 방법을 구체적으로 설명해주세요.
5. 만약 사용자가 숏츠 제작을 요청했다면, 마지막에 "✅ 분석 완료! 지금 바로 숏츠 제작을 시작하겠습니다."라고 말해주세요.

사용자의 요청과 현재 설정을 바탕으로 전문적이고 구체적인 조언을 제공해주세요.`;
                    
                    // 직접 AI API 호출 (sendToAI 대신)
                    const selectedModelKey = mainModelSelect.value;
                    const selectedSubModel = subModelSelect.value;
                    const modelData = aiModels[selectedModelKey];
                    
                    if (!modelData.apiKey) {
                        throw new Error(`${modelData.name} API 키가 설정되지 않았습니다.`);
                    }

                    const systemPrompt = `당신은 숏츠 영상 제작을 도와주는 AI 어시스턴트입니다. 
사용자가 영상 편집과 관련된 질문을 하면 친절하고 전문적으로 답변해주세요.
영상 처리, 편집, 플랫폼별 최적화에 대한 조언을 제공할 수 있습니다.
사용자가 구체적인 작업을 요청하면 단계별로 안내해주세요.`;

                    switch (selectedModelKey) {
                        case 'claude':
                            return await callClaudeAPI(analysisPrompt, systemPrompt, modelData, selectedSubModel);
                        case 'gpt':
                            return await callOpenAIAPI(analysisPrompt, systemPrompt, modelData, selectedSubModel);
                        case 'gemini':
                            return await callGeminiAPI(analysisPrompt, systemPrompt, modelData, selectedSubModel);
                        case 'groq':
                            return await callGroqAPI(analysisPrompt, systemPrompt, modelData, selectedSubModel);
                        case 'perplexity':
                            return await callPerplexityAPI(analysisPrompt, systemPrompt, modelData, selectedSubModel);
                        case 'cohere':
                            return await callCohereAPI(analysisPrompt, systemPrompt, modelData, selectedSubModel);
                        default:
                            throw new Error('지원하지 않는 AI 모델입니다.');
                    }
                    
                } catch (error) {
                    console.error('Video analysis error:', error);
                    return `영상 분석 중 오류가 발생했습니다: ${error.message}`;
                }
            }

            // --- AI API Functions ---
            async function sendToAI(message) {
                const selectedModelKey = mainModelSelect.value;
                const selectedSubModel = subModelSelect.value;
                const modelData = aiModels[selectedModelKey];
                
                if (!modelData.apiKey) {
                    throw new Error(`${modelData.name} API 키가 설정되지 않았습니다. 설정 버튼을 클릭하여 API 키를 입력해주세요.`);
                }

                // Check if this is a video analysis request
                const videoAnalysisKeywords = ['영상', '비디오', '분석', '하이라이트', '편집', '크롭', '자막', '효과'];
                const isVideoAnalysis = videoAnalysisKeywords.some(keyword => message.includes(keyword)) && uploadedFile;
                
                if (isVideoAnalysis) {
                    return await analyzeVideoContent(message);
                }

                // 현재 선택된 옵션들도 일반 대화에 포함
                const currentOptions = getCurrentOptions();
                const optionsText = formatOptionsForAI(currentOptions);
                
                const systemPrompt = `당신은 숏츠 영상 제작을 도와주는 AI 어시스턴트입니다. 
사용자가 영상 편집과 관련된 질문을 하면 친절하고 전문적으로 답변해주세요.
영상 처리, 편집, 플랫폼별 최적화에 대한 조언을 제공할 수 있습니다.
사용자가 구체적인 작업을 요청하면 단계별로 안내해주세요.

${optionsText}

현재 선택된 옵션들을 항상 고려하여 맞춤형 조언을 제공해주세요.
만약 사용자가 숏츠 제작을 요청하면 "✅ 분석 완료! 지금 바로 숏츠 제작을 시작하겠습니다."라고 응답해주세요.`;

                switch (selectedModelKey) {
                    case 'claude':
                        return await callClaudeAPI(message, systemPrompt, modelData, selectedSubModel);
                    case 'gpt':
                        return await callOpenAIAPI(message, systemPrompt, modelData, selectedSubModel);
                    case 'gemini':
                        return await callGeminiAPI(message, systemPrompt, modelData, selectedSubModel);
                    case 'groq':
                        return await callGroqAPI(message, systemPrompt, modelData, selectedSubModel);
                    case 'perplexity':
                        return await callPerplexityAPI(message, systemPrompt, modelData, selectedSubModel);
                    case 'cohere':
                        return await callCohereAPI(message, systemPrompt, modelData, selectedSubModel);
                    default:
                        throw new Error('지원하지 않는 AI 모델입니다.');
                }
            }

            async function callClaudeAPI(message, systemPrompt, modelData, subModel) {
                const modelMap = {
                    "Claude 3.5 Sonnet": "claude-3-5-sonnet-20241022",
                    "Claude 3.5 Haiku": "claude-3-5-haiku-20241022",
                    "Claude 3 Opus": "claude-3-opus-20240229",
                    "Claude 3 Sonnet": "claude-3-sonnet-20240229", 
                    "Claude 3 Haiku": "claude-3-haiku-20240307"
                };

                const response = await fetch(modelData.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': modelData.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: modelMap[subModel] || "claude-3-5-sonnet-20241022",
                        max_tokens: 1000,
                        system: systemPrompt,
                        messages: [
                            {
                                role: "user",
                                content: message
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Claude API 오류: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.content[0].text;
            }

            async function callOpenAIAPI(message, systemPrompt, modelData, subModel) {
                const modelMap = {
                    "GPT-4o": "gpt-4o",
                    "GPT-4o mini": "gpt-4o-mini",
                    "GPT-4 Turbo": "gpt-4-turbo",
                    "GPT-4": "gpt-4",
                    "GPT-3.5 Turbo": "gpt-3.5-turbo",
                    "GPT-3.5 Turbo 16k": "gpt-3.5-turbo-16k"
                };

                const response = await fetch(modelData.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${modelData.apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelMap[subModel] || "gpt-4o-mini",
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user", 
                                content: message
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`OpenAI API 오류: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async function callGeminiAPI(message, systemPrompt, modelData, subModel) {
                const modelMap = {
                    "Gemini 2.0 Flash": "gemini-2.0-flash-exp",
                    "Gemini 1.5 Pro": "gemini-1.5-pro-latest",
                    "Gemini 1.5 Flash": "gemini-1.5-flash-latest",
                    "Gemini 1.5 Flash-8B": "gemini-1.5-flash-8b-latest",
                    "Gemini 1.0 Pro": "gemini-pro"
                };
                
                const modelName = modelMap[subModel] || "gemini-pro";
                const url = `${modelData.endpoint}/${modelName}:generateContent?key=${modelData.apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `${systemPrompt}\n\n사용자 질문: ${message}`
                            }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 1000,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Gemini API 오류: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            async function callGroqAPI(message, systemPrompt, modelData, subModel) {
                const modelMap = {
                    "Llama 3.3 70B": "llama-3.3-70b-versatile",
                    "Llama 3.1 405B": "llama-3.1-405b-reasoning",
                    "Llama 3.1 70B": "llama-3.1-70b-versatile",
                    "Llama 3.1 8B": "llama-3.1-8b-instant",
                    "Llama 3 70B": "llama3-70b-8192",
                    "Llama 3 8B": "llama3-8b-8192",
                    "Mixtral 8x7B": "mixtral-8x7b-32768",
                    "Gemma 2 9B": "gemma2-9b-it",
                    "Gemma 7B": "gemma-7b-it"
                };

                const response = await fetch(modelData.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${modelData.apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelMap[subModel] || "llama-3.1-8b-instant",
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user",
                                content: message
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Groq API 오류: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async function callPerplexityAPI(message, systemPrompt, modelData, subModel) {
                const modelMap = {
                    "Llama 3.1 Sonar Large": "llama-3.1-sonar-large-128k-online",
                    "Llama 3.1 Sonar Small": "llama-3.1-sonar-small-128k-online",
                    "Llama 3.1 70B": "llama-3.1-70b-instruct",
                    "Llama 3.1 8B": "llama-3.1-8b-instruct"
                };

                const response = await fetch(modelData.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${modelData.apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelMap[subModel] || "llama-3.1-sonar-small-128k-online",
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user",
                                content: message
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Perplexity API 오류: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async function callCohereAPI(message, systemPrompt, modelData, subModel) {
                const modelMap = {
                    "Command R+": "command-r-plus",
                    "Command R": "command-r",
                    "Command": "command",
                    "Command Light": "command-light"
                };

                const response = await fetch(modelData.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${modelData.apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelMap[subModel] || "command-r",
                        message: message,
                        preamble: systemPrompt,
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Cohere API 오류: ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                return data.text;
            }

            // --- Theme Switching ---
            function applyInitialTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.body.classList.toggle('dark-mode', savedTheme === 'dark');
                themeToggle.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            }

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                themeToggle.textContent = isDarkMode ? '☀️' : '🌙';
            });

            loadNewVideoButton.addEventListener('click', () => {
                fileInput.click();
            });

            applyInitialTheme();

            // --- File Upload Logic ---
            function handleFile(file) {
                if (!file || !file.type.startsWith('video/')) {
                    alert('유효한 비디오 파일을 선택해주세요.');
                    return;
                }
                uploadedFile = file;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    videoPreview.src = e.target.result;
                    videoPreview.load();
                };
                reader.readAsDataURL(file);

                uploadContainer.style.display = 'none';
                videoEditorContainer.style.display = 'block';
                updateProcessButtonState();
            }
            
            uploadContainer.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleFile(e.target.files[0]);
            });

            uploadContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadContainer.classList.add('dragover');
            });
            uploadContainer.addEventListener('dragleave', () => {
                uploadContainer.classList.remove('dragover');
            });
            uploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadContainer.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
            });

            // --- Platform Selection ---
            platformCards.forEach(card => {
                card.addEventListener('click', () => {
                    card.classList.toggle('selected');
                    updateProcessButtonState();
                });
            });

            function getSelectedPlatforms() {
                return document.querySelectorAll('.platform-card.selected');
            }

            // --- Process Button State ---
            function updateProcessButtonState() {
                const platformsSelected = getSelectedPlatforms().length > 0;
                processBtn.disabled = !uploadedFile || !platformsSelected;
                sendChatBtn.disabled = chatInput.value.trim() === '';
            }

            // --- Chat Panel Logic ---
            function renderChatHistory() {
                chatHistory.innerHTML = '';
                const currentChat = chats.find(chat => chat.id === currentChatId);
                if (!currentChat) return;

                currentChat.messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message', `${msg.sender}-message`);

                    const avatar = `<div class="avatar">${msg.sender === 'ai' ? '🤖' : '👤'}</div>`;
                    const content = `<div class="message-content"><p>${msg.text}</p></div>`;
                    
                    messageElement.innerHTML = avatar + content;
                    chatHistory.appendChild(messageElement);
                });
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            function addMessage(sender, text) {
                const currentChat = chats.find(chat => chat.id === currentChatId);
                if (currentChat) {
                    currentChat.messages.push({ sender, text });
                    saveChats();
                    renderChatHistory();
                }
            }

            async function handleSendMessage() {
                const text = chatInput.value.trim();
                if (text) {
                    addMessage('user', text);
                    chatInput.value = '';
                    updateProcessButtonState();
                    
                    // Show typing indicator
                    addMessage('ai', '🤔 생각중...');
                    
                    try {
                        const aiResponse = await sendToAI(text);
                        // Remove typing indicator
                        const currentChat = chats.find(chat => chat.id === currentChatId);
                        if (currentChat && currentChat.messages.length > 0) {
                            currentChat.messages.pop(); // Remove typing indicator
                        }
                        addMessage('ai', aiResponse);
                        
                        // Check if AI suggests processing or analysis is complete
                        if (aiResponse.includes("✅ 분석 완료! 지금 바로 숏츠 제작을 시작하겠습니다.") || 
                            aiResponse.includes("영상 처리를 시작") || 
                            text.includes("처리 시작") || 
                            text.includes("만들어줘") ||
                            text.includes("숏츠 만들어") ||
                            text.includes("숏츠 생성") ||
                            text.includes("제작해")) {
                            
                            // 플랫폼이 선택되지 않은 경우 경고
                            const selectedPlatforms = getSelectedPlatforms();
                            if (selectedPlatforms.length === 0) {
                                setTimeout(() => {
                                    addMessage('ai', '⚠️ 플랫폼을 먼저 선택해주세요. 왼쪽 하단에서 YouTube Shorts, Instagram Reels 등 원하는 플랫폼을 선택한 후 다시 요청해주세요.');
                                }, 500);
                                return;
                            }
                            
                            setTimeout(() => {
                                addMessage('ai', '🚀 선택하신 옵션들을 적용하여 숏츠 제작을 시작합니다!');
                                processBtn.click();
                            }, 1000);
                        }
                    } catch (error) {
                        // Remove typing indicator
                        const currentChat = chats.find(chat => chat.id === currentChatId);
                        if (currentChat && currentChat.messages.length > 0) {
                            currentChat.messages.pop();
                        }
                        addMessage('ai', `오류가 발생했습니다: ${error.message}`);
                    }
                }
            }
            
            sendChatBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
             chatInput.addEventListener('input', updateProcessButtonState);

            // Chat Management
            function saveChats() {
                localStorage.setItem('autoshorts_chats', JSON.stringify(chats));
            }

            function loadChats() {
                const savedChats = localStorage.getItem('autoshorts_chats');
                if (savedChats) {
                    chats = JSON.parse(savedChats);
                    const lastChat = chats[chats.length - 1];
                    if (lastChat) {
                        currentChatId = lastChat.id;
                    } else {
                        startNewChat(false); // Don't save yet
                    }
                } else {
                    startNewChat(false); // Don't save yet
                }
                renderAll();
            }

            function startNewChat(doSave = true) {
                const newChat = {
                    id: Date.now(),
                    messages: [
                        { sender: 'ai', text: `안녕하세요! 🎬 숏츠 영상 제작을 도와드릴 AI 어시스턴트입니다.

📋 사용 방법:
1. 영상을 업로드해주세요
2. 원하는 처리 옵션을 선택하세요  
3. 저에게 "영상을 분석해줘", "하이라이트를 찾아줘" 등을 요청하거나
4. '영상 처리 시작' 버튼을 눌러주세요

💡 AI 기능:
- 영상 내용 분석 및 최적 구간 추천
- 플랫폼별 맞춤 편집 제안
- 자동 하이라이트 추출
- 개인화된 편집 조언

궁금한 점이 있으시면 언제든 물어보세요!` }
                    ]
                };
                chats.push(newChat);
                currentChatId = newChat.id;
                if (doSave) {
                   saveChats();
                }
                renderAll();
            }

            newChatBtn.addEventListener('click', () => startNewChat());

            function renderAll() {
                renderChatList();
                renderChatHistory();
            }

            // --- Chat List Logic ---
            function renderChatList() {
                chatList.innerHTML = '';
                if (chats.length === 0) {
                    chatList.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 1rem;">대화 기록이 없습니다.</p>`;
                    return;
                }

                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'chat-list-item';
                    item.dataset.chatId = chat.id;
                    if (chat.id === currentChatId) {
                        item.classList.add('active');
                    }

                    const firstUserMessage = chat.messages.find(m => m.sender === 'user');
                    const title = firstUserMessage ? firstUserMessage.text : (chat.messages[0]?.text || '새 대화');

                    item.innerHTML = `
                        <input type="checkbox" class="chat-select-checkbox" data-chat-id="${chat.id}">
                        <span class="chat-list-item-title">${title}</span>
                    `;

                    item.querySelector('.chat-list-item-title').addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentChatId = chat.id;
                        renderAll();
                    });

                    chatList.appendChild(item);
                });
            }

            function getSelectedChatIds() {
                const selected = [];
                document.querySelectorAll('.chat-select-checkbox:checked').forEach(cb => {
                    selected.push(Number(cb.dataset.chatId));
                });
                return selected;
            }

            selectAllChats.addEventListener('change', (e) => {
                document.querySelectorAll('.chat-select-checkbox').forEach(cb => {
                    cb.checked = e.target.checked;
                });
            });

            deleteChatsBtn.addEventListener('click', () => {
                const idsToDelete = getSelectedChatIds();
                if (idsToDelete.length === 0) {
                    alert('삭제할 대화를 선택해주세요.');
                    return;
                }
                
                if (!confirm(`${idsToDelete.length}개의 대화를 정말 삭제하시겠습니까?`)) {
                    return;
                }

                chats = chats.filter(chat => !idsToDelete.includes(chat.id));

                if (idsToDelete.includes(currentChatId)) {
                    currentChatId = chats.length > 0 ? chats[0].id : null;
                    if (!currentChatId) {
                        startNewChat(false); // Don't save yet, will be saved below
                    }
                }
                
                saveChats();
                renderAll();
            });

            function downloadJSON(data, filename) {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            saveChatsBtn.addEventListener('click', () => {
                downloadJSON(chats, 'all_chats.json');
            });
            
            loadChatsBtn.addEventListener('click', () => {
                loadChatsInput.click();
            });

            loadChatsInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedChats = JSON.parse(event.target.result);
                        if (Array.isArray(loadedChats)) {
                            // Basic validation
                            const validChats = loadedChats.filter(c => c.id && Array.isArray(c.messages));
                            const existingIds = new Set(chats.map(c => c.id));
                            const newChats = validChats.filter(c => !existingIds.has(c.id));
                            
                            chats.push(...newChats);
                            saveChats();
                            renderAll();
                            alert(`${newChats.length}개의 새 대화를 불러왔습니다.`);
                        } else {
                            throw new Error('Invalid chat file format.');
                        }
                    } catch (err) {
                        alert('대화 파일을 불러오는 중 오류가 발생했습니다.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
                // Reset input value to allow loading the same file again
                e.target.value = ''; 
            });

            // --- Carousel Logic ---
            function renderCompletedShorts() {
                shortsTrack.innerHTML = '';
                if (allGeneratedShorts.length === 0) {
                    shortsTrack.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 5rem 1rem;">왼쪽의 '영상 처리 시작' 버튼을 눌러 숏츠를 생성해주세요.</p>`;
                    prevShortBtn.style.display = 'none';
                    nextShortBtn.style.display = 'none';
                    shortsCounter.textContent = '';
                    return;
                }

                allGeneratedShorts.forEach(shortElement => {
                    // Each item needs to be wrapped for the carousel
                    const slide = document.createElement('div');
                    slide.style.flex = '0 0 100%';
                    slide.appendChild(shortElement);
                    shortsTrack.appendChild(slide);
                });

                updateCarousel();
            }

            function updateCarousel() {
                // Move the track
                const offset = -currentShortIndex * 100;
                shortsTrack.style.transform = `translateX(${offset}%)`;

                // Update counter
                shortsCounter.textContent = `${currentShortIndex + 1} / ${allGeneratedShorts.length}`;

                // Update buttons visibility
                prevShortBtn.style.display = currentShortIndex > 0 ? 'block' : 'none';
                nextShortBtn.style.display = currentShortIndex < allGeneratedShorts.length - 1 ? 'block' : 'none';

                // Pause all videos first
                shortsTrack.querySelectorAll('video').forEach(v => v.pause());

                // Autoplay current video on hover
                const currentSlide = shortsTrack.children[currentShortIndex];
                if (currentSlide) {
                    const videoContainer = currentSlide.querySelector('.video-container');
                    const video = currentSlide.querySelector('video');
                    if (videoContainer && video) {
                         videoContainer.addEventListener('mouseenter', () => video.play().catch(e=>console.log("Autoplay failed", e)));
                         videoContainer.addEventListener('mouseleave', () => video.pause());
                    }
                }
            }

            prevShortBtn.addEventListener('click', () => {
                if (currentShortIndex > 0) {
                    currentShortIndex--;
                    updateCarousel();
                }
            });

            nextShortBtn.addEventListener('click', () => {
                if (currentShortIndex < allGeneratedShorts.length - 1) {
                    currentShortIndex++;
                    updateCarousel();
                }
            });

            // --- Video Processing Functions ---
            async function processVideoWithAI() {
                if (!uploadedFile || !videoPreview.src) {
                    throw new Error("처리할 영상이 없습니다.");
                }
                
                // Get processing options
                const options = {
                    autoHighlight: document.getElementById('autoHighlight').checked,
                    autoCrop: document.getElementById('autoCrop').checked,
                    colorCorrection: document.getElementById('colorCorrection').checked,
                    videoStabilization: document.getElementById('videoStabilization').checked,
                    removeSilence: document.getElementById('removeSilence').checked,
                    enhanceAudio: document.getElementById('enhanceAudio').checked,
                    noiseReduction: document.getElementById('noiseReduction').checked,
                    addTitle: document.getElementById('addTitle').checked,
                    addSubtitles: document.getElementById('addSubtitles').checked,
                    addEffects: document.getElementById('addEffects').checked,
                    shortsLength: parseInt(document.getElementById('shortsLength').value),
                    shortsCount: parseInt(document.getElementById('shortsCount').value)
                };
                
                // Get current options for AI analysis
                const currentOptions = getCurrentOptions();
                const optionsText = formatOptionsForAI(currentOptions);
                
                // Ask AI for processing recommendations
                const analysisMessage = `
AI 기반 숏츠 자동 제작을 시작합니다.

${optionsText}

🎯 제작 목표:
- ${options.shortsCount}개의 ${options.shortsLength}초 숏츠 생성
- 선택된 플랫폼에 최적화된 편집
- 모든 선택된 처리 옵션 적용

영상을 분석하여 최적의 구간을 선택하고 편집 방향을 제시해주세요.`;
                
                const aiAnalysis = await analyzeVideoContent(analysisMessage);
                addMessage('ai', aiAnalysis);
                
                return await generateShortsWithAI(options, aiAnalysis);
            }
            
            async function generateShortsWithAI(options, aiAnalysis) {
                const originalVideo = videoPreview;
                const videoSrc = originalVideo.src;
                const originalDuration = originalVideo.duration;
                const generatedShorts = [];
                
                if (originalDuration < options.shortsLength) {
                    throw new Error(`원본 영상(${Math.round(originalDuration)}초)이 요청된 숏츠 길이(${options.shortsLength}초)보다 짧습니다.`);
                }
                
                // AI 분석을 바탕으로 최적의 구간 선택
                const segments = await selectBestSegments(originalDuration, options.shortsLength, options.shortsCount, aiAnalysis);
                
                for (let i = 0; i < segments.length; i++) {
                    const segment = segments[i];
                    const newShort = await createShortFromSegment(segment, videoSrc, options, i + 1);
                    generatedShorts.push(newShort);
                }
                
                return generatedShorts;
            }
            
            async function selectBestSegments(duration, segmentLength, count, aiAnalysis) {
                // 간단한 알고리즘으로 구간 선택 (나중에 AI 분석 결과를 더 활용할 수 있음)
                const segments = [];
                const maxStartTime = duration - segmentLength;
                
                if (count === 1) {
                    // 단일 숏츠의 경우 중간 부분 선택
                    const startTime = Math.max(0, (duration - segmentLength) / 2);
                    segments.push({
                        startTime: startTime,
                        endTime: startTime + segmentLength,
                        confidence: 0.8
                    });
                } else {
                    // 여러 숏츠의 경우 균등하게 분산
                    const interval = maxStartTime / (count - 1);
                    for (let i = 0; i < count; i++) {
                        const startTime = Math.min(i * interval, maxStartTime);
                        segments.push({
                            startTime: startTime,
                            endTime: startTime + segmentLength,
                            confidence: 0.7 + (Math.random() * 0.2) // 임시 신뢰도
                        });
                    }
                }
                
                return segments;
            }
            
            async function createShortFromSegment(segment, videoSrc, options, index) {
                const segmentSrc = `${videoSrc}#t=${segment.startTime},${segment.endTime}`;
                
                // 적용된 옵션들을 표시하기 위한 배지 생성
                const appliedOptions = [];
                if (options.autoHighlight) appliedOptions.push("🎯 하이라이트");
                if (options.autoCrop) appliedOptions.push("✂️ 크롭");
                if (options.colorCorrection) appliedOptions.push("🎨 색상보정");
                if (options.videoStabilization) appliedOptions.push("📹 안정화");
                if (options.removeSilence) appliedOptions.push("🔇 무음제거");
                if (options.enhanceAudio) appliedOptions.push("🔊 음질향상");
                if (options.addSubtitles) appliedOptions.push("💬 자막");
                if (options.addEffects) appliedOptions.push("✨ 효과");
                
                const optionsBadges = appliedOptions.length > 0 
                    ? `<div style="font-size: 0.75rem; color: var(--accent-color); margin-bottom: 0.5rem;">${appliedOptions.join(' ')}</div>`
                    : '';
                
                const newShort = document.createElement('div');
                newShort.className = 'short-item';
                newShort.innerHTML = `
                    <div class="video-container">
                        <video src="${segmentSrc}" loop preload="metadata"></video>
                        <div class="video-overlay">▶</div>
                        <button class="volume-btn">🔊</button>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill"></div>
                    </div>
                    <div class="short-info">
                        ${optionsBadges}
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">
                            숏츠 #${index} (${Math.round(segment.startTime)}s-${Math.round(segment.endTime)}s)
                        </span>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="download-btn" onclick="downloadSingleShort(this, ${index})">다운로드</button>
                            <button class="upload-btn">업로드</button>
                            <button class="delete-btn">삭제</button>
                        </div>
                    </div>`;
                
                // Add event listeners
                setupShortEventListeners(newShort);
                
                return newShort;
            }
            
            function setupShortEventListeners(shortElement) {
                const video = shortElement.querySelector('video');
                const volumeBtn = shortElement.querySelector('.volume-btn');
                const progressBarContainer = shortElement.querySelector('.progress-bar-container');
                const progressBarFill = shortElement.querySelector('.progress-bar-fill');
                const uploadBtn = shortElement.querySelector('.upload-btn');
                const deleteBtn = shortElement.querySelector('.delete-btn');

                // Volume control
                volumeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (video.muted) {
                        video.muted = false;
                        volumeBtn.textContent = '🔊';
                    } else {
                        video.muted = true;
                        volumeBtn.textContent = '🔇';
                    }
                });

                // Progress bar update
                video.addEventListener('timeupdate', () => {
                    if (video.duration) {
                        const progressPercent = (video.currentTime / video.duration) * 100;
                        progressBarFill.style.width = `${progressPercent}%`;
                    }
                });

                // Seek on progress bar click
                progressBarContainer.addEventListener('click', (e) => {
                    const rect = progressBarContainer.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = progressBarContainer.clientWidth;
                    if (video.duration) {
                        video.currentTime = (clickX / width) * video.duration;
                    }
                });
                
                // Upload button opens modal
                uploadBtn.addEventListener('click', () => {
                    const uploadModal = document.getElementById('uploadModal');
                    uploadModal.classList.add('active');
                });
                
                // Delete button removes the short
                deleteBtn.addEventListener('click', () => {
                    const indexToRemove = allGeneratedShorts.findIndex(item => item === shortElement);
                    if (indexToRemove > -1) {
                        allGeneratedShorts.splice(indexToRemove, 1);
                        if (allGeneratedShorts.length === 0) {
                            currentShortIndex = 0;
                        } else {
                            if (currentShortIndex >= indexToRemove) {
                                currentShortIndex = Math.max(0, currentShortIndex - 1);
                            }
                        }
                        renderCompletedShorts();
                    }
                });
            }

            // --- Main Processing Logic ---
            processBtn.addEventListener('click', async () => {
                if (processBtn.disabled) return;
                
                addMessage('ai', "🚀 AI 기반 영상 처리를 시작합니다. 잠시만 기다려주세요...");

                shortsTrack.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 5rem 1rem;">AI가 영상을 분석하고 처리하고 있습니다...</p>';
                allGeneratedShorts = [];
                currentShortIndex = 0;
                updateCarousel();
                
                                try {
                    const processedShorts = await processVideoWithAI();
                    allGeneratedShorts = processedShorts;
                    renderCompletedShorts();
                    
                    addMessage('ai', `✅ ${processedShorts.length}개의 AI 최적화된 숏츠 영상이 완성되었습니다! 오른쪽 패널에서 확인해주세요.`);
                    
                    // Auto-save if enabled
                    if (autoSave.checked) {
                        setTimeout(() => autoSaveShorts(), 1000);
                    }
                } catch (error) {
                     console.error('Processing error:', error);
                     addMessage('ai', `❌ 처리 중 오류가 발생했습니다: ${error.message}`);
                     shortsTrack.innerHTML = `<p style="text-align: center; color: var(--error-text); padding: 5rem 1rem;">처리 실패: ${error.message}</p>`;
                 }
             });

            // --- Upload Modal Logic ---
            const uploadModal = document.getElementById('uploadModal');
            const cancelUpload = document.getElementById('cancelUpload');
            const confirmUpload = document.getElementById('confirmUpload');
            
            cancelUpload.addEventListener('click', () => {
                uploadModal.classList.remove('active');
            });
            
            confirmUpload.addEventListener('click', () => {
                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;
                const tags = document.getElementById('videoTags').value;
                
                if (!title.trim()) {
                    alert('제목을 입력해주세요.');
                    return;
                }
                
                // 실제로는 여기서 선택된 플랫폼에 업로드하는 로직이 들어갑니다
                const selectedPlatforms = Array.from(getSelectedPlatforms()).map(p => p.dataset.platform);
                
                addMessage('ai', `${selectedPlatforms.join(', ')}에 "${title}" 제목으로 업로드를 시작합니다...`);
                
                // 시뮬레이션
                setTimeout(() => {
                    addMessage('ai', '✅ 업로드가 완료되었습니다!');
                }, 2000);
                
                uploadModal.classList.remove('active');
                
                // 폼 초기화
                document.getElementById('videoTitle').value = '';
                document.getElementById('videoDescription').value = '';
                document.getElementById('videoTags').value = '';
            });
            
            // Close modal when clicking outside
            uploadModal.addEventListener('click', (e) => {
                if (e.target === uploadModal) {
                    uploadModal.classList.remove('active');
                }
            });

            // --- Initial Setup ---
            loadSavedApiKeys();
            loadStorageSettings();
            loadChats();
            renderCompletedShorts();
            initializeMainModels();
            updateSubModels();
            updateProcessButtonState();
        });
    </script>
</body>
</html>